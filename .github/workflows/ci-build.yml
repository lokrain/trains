name: ci-build

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build Assembly-CSharp
        run: dotnet build Assembly-CSharp.csproj -c Release

      - name: Run Sprint 4 gates
        shell: pwsh
        run: .github/scripts/run-sprint4-gates.ps1

      - name: Export asmdef dependency graph (Mermaid)
        shell: pwsh
        run: .github/scripts/validate-asmdef-deps.ps1 -AsMermaid -MermaidPath asmdef-deps.mmd

      - name: Export asmdef dependency report (JSON)
        shell: pwsh
        run: .github/scripts/validate-asmdef-deps.ps1 -AsJson -JsonPath asmdef-deps.json

      - name: Upload asmdef graph artifact
        uses: actions/upload-artifact@v4
        with:
          name: asmdef-deps
          path: |
            asmdef-deps.mmd
            asmdef-deps.json

      - name: Upload Sprint 4 gates summary
        uses: actions/upload-artifact@v4
        with:
          name: sprint4-gates
          path: |
            sprint4-gates.md
            sprint4-gates.json

      - name: Render throughput benchmark scaffold
        shell: pwsh
        run: .github/scripts/run-render-throughput-bench.ps1

      - name: Upload render throughput benchmark scaffold
        uses: actions/upload-artifact@v4
        with:
          name: render-throughput-bench
          path: render-throughput-bench.md
