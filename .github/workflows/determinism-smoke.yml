name: determinism-smoke

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  determinism-smoke:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build deterministic infrastructure
        run: dotnet build Assembly-CSharp.csproj -c Release

      - name: Verify deterministic scaffolding files
        shell: pwsh
        run: |
          $required = @(
            'Assets/Scripts/Infra/Determinism/DeterministicRngStreams.cs',
            'Assets/Scripts/Infra/Determinism/DeterministicHashing.cs',
            'Assets/Scripts/Infra/Determinism/ReplayDeterminismHarness.cs',
            'Assets/Scripts/Core/Simulation/DeterminismHashSystem.cs',
            'Assets/Scripts/Core/Net/Protocol/Crc64SelfTest.cs',
            'Assets/Scripts/Core/Net/Protocol/ReplicationProtocolSelfTest.cs',
            'Assets/Scripts/Core/Net/Protocol/SnapshotReassemblySelfTest.cs',
            'Assets/Scripts/Core/Net/Protocol/ReassemblyChurnSelfTest.cs',
            'Assets/Scripts/Core/Net/Protocol/ReassemblyMemoryTrendSelfTest.cs',
            'Assets/Scripts/Core/Net/Protocol/ReplicationSelfTestSuite.cs',
            'Assets/Scripts/Core/Client/Net/WorldPatchReceiverSelfTest.cs',
            'Assets/Scripts/Core/Client/Net/SnapshotPatchEquivalenceSelfTest.cs',
            'Assets/Scripts/Core/Client/Net/PatchChainPropertySelfTest.cs',
            'Assets/Scripts/Core/Client/Render/ChunkMeshDeterminismSelfTest.cs',
            'Assets/Scripts/Core/Client/Render/ChunkMeshPatchEquivalenceSelfTest.cs',
            'Assets/Scripts/Core/Client/Render/ChunkMeshSeamSelfTest.cs',
            'Assets/Scripts/Core/Server/Net/ChunkStreamSchedulerSelfTest.cs',
            'Assets/Scripts/Core/Rails/SegmentSpec16SelfTest.cs',
            'Assets/Scripts/Core/Rails/RailIdsSelfTest.cs',
            'Assets/Scripts/Core/Rails/RailGraphCoreSelfTest.cs',
            'Assets/Scripts/Core/Rails/RailTraversalSelfTest.cs',
            'Assets/Scripts/Core/Rails/RailMutationEventsSelfTest.cs',
            'Assets/Scripts/Core/Rails/RailSegmentDeltaEncoderSelfTest.cs',
            'Assets/Scripts/Core/Rails/RailSpatialIndexSelfTest.cs',
            'Assets/Scripts/Core/Rails/TileEdgeKeySelfTest.cs',
            'Assets/Scripts/Core/Rails/RailMutationStressSelfTest.cs',
            'Assets/Scripts/Core/Rails/RailWireContractSelfTest.cs',
            'Assets/Scripts/Core/Rails/RailIndexDriftSelfTest.cs',
            'Assets/Scripts/Core/Rails/RailScale100kSelfTest.cs',
            'Assets/Scripts/Presentation/WorldRendering/ChunkRenderInvalidationSelfTest.cs',
            'Assets/Scripts/Presentation/WorldRendering/ChunkRenderBudgetSelfTest.cs',
            'Assets/Scripts/Presentation/WorldRendering/ChunkPresenterLifecycleSelfTest.cs',
            'Assets/Scripts/Core/WorldGen/RiverSeamScanner.cs',
            'Assets/Scripts/Core/Simulation/WorldGenDeterminismRunner.cs',
            'docs/adr/0006-snapshot-fragmentation-reassembly-safety.md',
            'docs/adr/0007-patch-lineage-mismatch-resync-policy.md',
            'docs/sprints/Sprint4-Closure-Evidence.md'
          )
          foreach ($f in $required) {
            if (-not (Test-Path $f)) {
              throw "Missing deterministic scaffold file: $f"
            }
          }

      - name: Run Sprint 4 gates
        shell: pwsh
        run: .github/scripts/run-sprint4-gates.ps1

      - name: Upload asmdef dependency artifacts
        uses: actions/upload-artifact@v4
        with:
          name: asmdef-deps-determinism-smoke
          path: |
            asmdef-deps.json

      - name: Upload Sprint 4 gates summary
        uses: actions/upload-artifact@v4
        with:
          name: sprint4-gates-determinism-smoke
          path: |
            sprint4-gates.md
            sprint4-gates.json
